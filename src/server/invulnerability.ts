import '#config/env';
import process         from 'process';
import { pgp }         from '#server/db/driver';

import type { Logger } from 'winston';

export function invulnerability(logger: Logger): void {
    const exit = () => {
        pgp.end();
        process.exit(0);
    };
    process.on('exit', exit);

    for(const sig of [ 'SIGINT', 'SIGTERM', 'SIGHUP', 'SIGQUIT' ]) {
        process.on(
            sig,
            () => {
                logger.error(sig);
                exit();
            }
        );
    }

    process.on(
        'uncaughtException',
        error => {
            logger.error(error.message);
            if(error.stack)
                process.stdout.write(error.stack);
            exit();
        }
    );
}

export default invulnerability;
