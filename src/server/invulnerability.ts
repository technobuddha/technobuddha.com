import '#config/env';

import { type Logger } from 'winston';

import { pgp } from './db/driver.ts';

function exit(): void {
  pgp.end();
  process.exit(0);
}

export function invulnerability(logger: Logger): void {
  process.on('exit', exit);

  for (const sig of ['SIGINT', 'SIGTERM', 'SIGHUP', 'SIGQUIT']) {
    process.on(sig, () => {
      logger.error(sig);
      exit();
    });
  }

  process.on('uncaughtException', (error) => {
    logger.error(error.message);
    if (error.stack) {
      process.stdout.write(error.stack);
    }
    exit();
  });
}
